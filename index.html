<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live ISP Dashboard | Data By Fakhrul</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --bg: #0b1120; --sidebar: #111b33; --card: #1e293b; --accent: #38bdf8;
            --text-main: #f3f4f6; --text-dim: #9ca3af;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: var(--sidebar); padding: 20px; display: flex; flex-direction: column; gap: 20px; border-right: 1px solid #1e293b; }
        .main-content { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .stat-card { background: var(--card); padding: 12px; border-radius: 10px; border: 1px solid #334155; text-align: center; }
        .stat-card small { color: var(--text-dim); font-size: 10px; text-transform: uppercase; }
        .stat-card div { font-size: 18px; font-weight: bold; color: var(--accent); }
        .dashboard-layout { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 15px; flex: 1; min-height: 0; }
        .box { background: var(--card); border-radius: 12px; padding: 15px; display: flex; flex-direction: column; border: 1px solid #334155; overflow: hidden; }
        .table-container { flex: 1; overflow-y: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { position: sticky; top: 0; background: #334155; padding: 10px; text-align: left; z-index: 5; color: var(--accent); }
        td { padding: 8px 10px; border-bottom: 1px solid #334155; }
        input, select { width: 100%; padding: 12px; background: #0f172a; color: white; border: 1px solid #334155; border-radius: 8px; box-sizing: border-box; outline: none; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 10px; color: white; font-weight: bold; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

<aside class="sidebar">
    <h2 style="color: var(--accent); margin: 0; font-size: 1.4rem;">Data By Fakhrul</h2>
    <div>
        <label><small>LIVE SEARCH</small></label>
        <input type="text" id="searchInput" placeholder="Type price or speed..." onkeyup="updateUI()">
    </div>
    <div>
        <label><small>PROVIDER</small></label>
        <select id="ispFilter" onchange="updateUI()"></select>
    </div>
    <div>
        <label><small>PRICE LIMIT</small></label>
        <select id="priceFilter" onchange="updateUI()">
            <option value="All">All Prices</option>
            <option value="0-1000">Under 1000</option>
            <option value="1001-2000">1001 - 2000</option>
            <option value="2001-99999">Above 2000</option>
        </select>
    </div>
    <button onclick="fetchData()" style="padding: 10px; background: var(--accent); border: none; border-radius: 8px; cursor: pointer; color: #0b1120; font-weight: bold;">Refresh Data</button>
</aside>

<main class="main-content">
    <div class="stats-grid">
        <div class="stat-card"><small>Matches</small><div id="statTotal">0</div></div>
        <div class="stat-card"><small>Highest Speed</small><div id="statSpeed">0</div></div>
        <div class="stat-card"><small>Average Price</small><div id="statAvg">0</div></div>
        <div class="stat-card"><small>Best Value</small><div id="statValue">0</div></div>
    </div>
    <div class="dashboard-layout">
        <div class="box">
            <h3 style="margin:0; font-size:14px; color:var(--accent)">MASTER DATA SHEET</h3>
            <div class="table-container">
                <table>
                    <thead><tr><th>ISP</th><th>SPEED</th><th>PRICE</th><th>SCORE</th></tr></thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>
        </div>
        <div class="box">
            <h3 style="margin:0; font-size:14px; color:var(--accent)">VISUAL COMPARISON</h3>
            <div style="flex:1; min-height:0; margin-top:10px;"><canvas id="marketChart"></canvas></div>
        </div>
    </div>
</main>

<script>
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSQkAq1_jVuTCRqMZNJrEBXczgCch8_KRGcqZVLETh7krJKrXyv0xSO9q5CGuie9kHgGuBxZD79N8tu/pub?output=csv';
    let fullData = [];
    let chart;
    const colors = { 'Udoy':'#facc15', 'AccessTel':'#a855f7', 'RangsIT':'#f97316', 'Orbit':'#3b82f6', 'ICC':'#22c55e', 'IncomIT':'#ec4899' };

    async function fetchData() {
        Papa.parse(sheetURL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                // Mapping based on your Google Sheet headers: Price, ISP, Bandwidth_Mbps
                fullData = results.data.map(d => ({
                    isp: d.ISP ? d.ISP.trim() : 'Unknown',
                    bw: parseInt(d.Bandwidth_Mbps) || 0,
                    p: parseInt(d.Price) || 0
                })).filter(d => d.bw > 0);
                
                populateISPFilter();
                updateUI();
            }
        });
    }

    function populateISPFilter() {
        const ispSelect = document.getElementById('ispFilter');
        const uniqueISPs = ['All', ...new Set(fullData.map(d => d.isp))];
        ispSelect.innerHTML = uniqueISPs.map(isp => `<option value="${isp}">${isp}</option>`).join('');
    }

    function updateUI() {
        const query = document.getElementById('searchInput').value.toLowerCase().trim();
        const selectedISP = document.getElementById('ispFilter').value;
        const priceRange = document.getElementById('priceFilter').value;

        const filtered = fullData.filter(d => {
            const matchesQuery = d.isp.toLowerCase().includes(query) || d.bw.toString().includes(query) || d.p.toString().includes(query);
            const matchesISP = (selectedISP === 'All' || d.isp === selectedISP);
            let matchesPrice = true;
            if (priceRange !== 'All') {
                const [min, max] = priceRange.split('-').map(Number);
                matchesPrice = (d.p >= min && d.p <= max);
            }
            return (query === "" || matchesQuery) && matchesISP && matchesPrice;
        });

        document.getElementById('statTotal').innerText = filtered.length;
        document.getElementById('statSpeed').innerText = (filtered.length ? Math.max(...filtered.map(d=>d.bw)) : 0) + ' Mbps';
        const avg = filtered.length ? filtered.reduce((a,c)=>a+c.p,0)/filtered.length : 0;
        document.getElementById('statAvg').innerText = '৳' + avg.toFixed(0);
        const best = filtered.length ? Math.max(...filtered.map(d=>d.bw/d.p)) : 0;
        document.getElementById('statValue').innerText = best.toFixed(4);

        const tbody = document.getElementById('dataTable');
        tbody.innerHTML = filtered.sort((a,b)=>a.p - b.p).map(d => `
            <tr>
                <td><span class="badge" style="background:${colors[d.isp] || '#6366f1'}">${d.isp}</span></td>
                <td><b>${d.bw} Mbps</b></td>
                <td>৳${d.p}</td>
                <td style="color:var(--accent)">${(d.bw/d.p).toFixed(4)}</td>
            </tr>
        `).join('');

        renderChart(filtered);
    }

    function renderChart(data) {
        const ctx = document.getElementById('marketChart').getContext('2d');
        if(chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(d => d.isp + ' ' + d.bw + 'M'),
                datasets: [{ label: 'Price (TK)', data: data.map(d => d.p), backgroundColor: data.map(d => colors[d.isp] || '#6366f1'), borderRadius: 6 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    fetchData();
</script>
</body>
</html>
